<html>
<head>
<link rel="stylesheet" type="text/css" href="stylesheets/style.css">

<script type="text/javascript" src="javascripts/jszip.js"></script>

<script type="text/javascript" src="javascripts/jszip-utils.js"></script>
<!--
Mandatory in IE 6, 7, 8 and 9.
-->
<!--[if IE]>
<script type="text/javascript" src="javascripts/jszip-utils-ie.js"></script>
<![endif]-->

<!--
Any version of jQuery will do (it's just to write some examples), this one
happens to be available in our tests.
-->
<script type="text/javascript" src="javascripts/jQuery-1.10.2.js"></script>

<script type="text/javascript" src="javascripts/FileSaver.js"></script>
<script type="text/javascript" src="javascripts/main.js"></script>

</head>

<body>
<h1>Simple Stream Integration Generator</h1>
<br />
<p><b>Integration Title</b>:</p>
<input type="text" style="width: 500px; height:40px" id="addon_name" value="My Activity Stream Integration" />

<br />
<br />
<p><b>Integration Description</b>:</p>
<textarea id="description" style="width: 500px; height:50px">This is my activity stream integration.</textarea>
<br />
<br />

<p></p><b>Integration Icon</b>:</p>
<form id="form1" runat="server">
    <input type='file' id="inputFile" />
    <img id="image_upload_preview" src="sample-icon-128.png" alt="your image" width="128px"/>
</form>

<p><b>Transform Function</b>:</p>
<p><em>This function must eu fugiat nulla pariatur excepteur sint occaecat cupidatat non proident. For more information
about the JSON schema of a Jive activity stream,
refer to <a href="https://community.jivesoftware.com/docs/DOC-133425">Creating an Activity Stream</a> in the Jive Community.</em></p>
&nbsp;&nbsp;<b>function transform(body, headers, options, callback)
&nbsp;&nbsp;{</b>
<br/><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<textarea id="xform_js" style="width: 500px; height:200px">
/*
 * TO DO: Parse 'body' arg based on incoming event from 3rd party system
 */

parsedBody = body.toString();

/*
 * TO DO: Replace the dummy code below with your own transformation code.
 */

// Build activity object.
var activityInfo = { action: {}, actor: {}, object:{} };

// Required name of action. Leave this as "posted".
activityInfo.action.name = "posted";

// Optional name of actor for this activity. Remove if n/a.
// activityInfo.actor.name = "Jane Doe";

// Optional email of actor for activity. Remove if n/a.
// activityInfo.actor.email = "janedoe@example.com";

// Required type of activity. Leave this as "website".
activityInfo.object.type = "website";

// Optional URL for this activity. Remove if n/a.
activityInfo.object.url = "http://developer.jivesoftware.com";

// Optional URL to the image for this activity. Remove if n/a.
//activityInfo.object.image = "https://my.domain.com/image.png";

// Required title of the activity.
activityInfo.object.title = "Name of Event";

// Optional HTML description of activity. Remove if n/a.
activityInfo.object.description = "Received this content: "+parsedBody;

/*
 * Call the callback function with our transformed activity information
 */

callback({ activity: activityInfo });
</textarea>
<br/><b>}</b>
<br /><br />
<button id="test_xform" class="btn btn-primary">Test Transform</button>
<br />
<br />
<div id="test_transform_div">
    <b>Test Your Transform</b><br/>
    <p><em>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et
    dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip
    ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore
    eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia
    deserunt mollit anim id est laborum.</em></p>

    <table width="550"  cellpadding="20">
    <tr><td><b>Sample Input</b><br /><textarea id="tx_input" style="width: 250px; height:200px">
{
  input1: "test",
  input2: "test"
}</textarea></td>
    <td><b>Resulting Output</b><br />
        <textarea id="tx_output" readonly style="width: 250px; height:200px">Not Started</textarea>
    </td>
    </tr>
    </table>
    <br />
    <p><b>Transform Function Test</b>: <span id="callback_check">N/A</span></p>
    <p><b>Output Validation Test</b>: <span id="validation_check">N/A</span></p>
    <br />
    <button id="run-transform" class="btn btn-primary">Run Transform</button>
    <button id="notest_xform" class="btn btn-primary">Hide Test</button>
    <br /><br />
</div>
<hr />
<br />

<button id="blob" class="btn btn-primary">Download Add-on Package</button>
<div id="j-notice" style="width: 50%"></div>

</body>

<head>
    <script>

        $('#test_xform').click(function () {
            $('#test_transform_div').show();
            $('#test_xform').hide();
        });
        $('#notest_xform').click(function () {
            $('#test_transform_div').hide();
            $('#test_xform').show();
        });

        $('#run-transform').click(function() {
            var input_data = $('textarea#tx_input').val();
            var xform_func = $('textarea#xform_js').val();
            var callback_reached = false;
            try {
                // clear output fields
                $('#tx_output').val('');
                $('#validation_check').html('N/A');
                $('#callback_check').html('N/A');

                // check if transform function is empty
                if (xform_func == null || xform_func.trim().length < 1) {
                    throw new Error("Transform function is empty");
                }

                // timer function in case callback isn't called
                function sentinel() {
                    if (!callback_reached) {
                        $('#callback_check').html('FAILED.<br/>Error: Callback never run');
                    }
                }

                // callback function to be executed by transform code
                function callback(data) {
                    callback_reached = true;
                    clearTimeout(timer_handle);
                    $('#callback_check').html('PASSED. Data sent to callback.');
                    try {
                        var resulting_Json;
                        if ( typeof data === 'function' ) {
                            throw new Error('Cannot pass function into callback')
                        }
                        else if ( typeof data === 'undefined') {
                            throw new Error('No data passed to callback')
                        }
                        else if ( typeof data === 'string' ) {
                            try {
                                resulting_Json = JSON.parse(data);
                            }
                            catch (err) {
                                throw new Error("Invalid JSON data passed to callback. "+err);
                            }
                        }
                        else {
                            resulting_Json = data;
                        }

                        // display output
                        $('#tx_output').val(JSON.stringify(data, null, 2));

                        // validate activity stream JSON
                        validateSchema(data);

                        // if we got here, then we passed
                        $('#validation_check').html('PASSED. Data format is valid.');

                    } catch (err) {
                        $('#validation_check').html('FAILED. '+err+
                          '<br/><br/>For more information about the JSON schema of a Jive activity stream, refer to <a href="https://community.jivesoftware.com/docs/DOC-133425">Creating an Activity Stream</a> in the Jive Community.');
                    }
                }

                // start a timer to check if callback is called in time
                var timer_handle =  setTimeout(sentinel,750);

                // run transform function
                var transformFunc = new Function('body', 'headers', 'optons', 'callback', xform_func);
                transformFunc(input_data, {}, {}, callback, xform_func);
            }
            catch (err) {
                clearTimeout(timer_handle);
                $('#callback_check').html('FAILED.<br/>'+err);
            }
        });

        function validateSchema(data) {
            if (!data.activity) {
                throw new Error('"activity" object not found.');
            }
            if (typeof data.activity !== 'object') {
                throw new Error('"activity" is not an object type.');
            }
            if (!data.activity.action) {
                throw new Error('"activity.action" object not found.');
            }
            if (typeof data.activity.action !== 'object') {
                throw new Error('"activity.action" is not an object type.');
            }
            if (!data.activity.action.name) {
                throw new Error('"activity.action.name" string not found.');
            }
            if (data.activity.action.name !== 'posted') {
                throw new Error('"activity.action.name" string should be "posted".');
            }
            if (!data.activity.object) {
                throw new Error('"activity.object" object not found.');
            }
            if (typeof data.activity.object !== 'object') {
                throw new Error('"activity.object" is not an object type.');
            }
            if (!data.activity.object.type) {
                throw new Error('"activity.object.type" string not found.');
            }
            if (data.activity.object.type !== 'website') {
                throw new Error('"activity.action.name" string should be "website".');
            }
            if (!data.activity.object.image) {
                throw new Error('"activity.object.image" string not found.');
            }
            if (typeof data.activity.object.image !== 'string') {
                throw new Error('"activity.object.image" should be the URL for the image.');
            }
            if (!data.activity.object.title) {
                throw new Error('"activity.object.title" string not found.');
            }
            if (typeof data.activity.object.title !== 'string') {
                throw new Error('"activity.object.title" should be a string.');
            }
        }

        $("#inputFile").change(function () {
            readURL(this);
        });

        $("#xform_js").focus();

        // Blob
        if (navigator.userAgent.indexOf('Safari') != -1 && navigator.userAgent.indexOf('Chrome') == -1) {
            $("#j-notice").html("<br>For Safari browsers, the file will download with a name like <b>Unknown</b>. " +
                    "You can upload this straightaway to your Jive instance, or rename name the file with a .zip extension to easily view its contents.");
            $('#blob').click( function() {
                window.location = "data:application/zip;base64," + createZip().generate({type:"base64"});
            } );
        } else {
            // other
            // safari
            var blobLink = document.getElementById('blob');
            if (JSZip.support.blob) {
                $('#blob').click( function() {
                    try {
                        var blob = createZip().generate({type:"blob"});
                        // see FileSaver.js
                        saveAs(blob, addonName + ".zip");
                    } catch(e) {
                        blobLink.innerHTML += " " + e;
                    }
                    return false;
                } );
            } else {
                blobLink.innerHTML += " (not supported on this browser)";
            }
        }
    </script>
</head>
</html>
